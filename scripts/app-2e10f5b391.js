!function(){"use strict";angular.module("gifseina",["ngAnimate","ngCookies","ngTouch","ngSanitize","ui.router","dropinput","angular-loading-bar","imageLoader","scroll","ripple","clipboard","firebase"])}(),function(){"use strict";function e(e,t,a,i,n,r,o,s,l,d){var c=this;c.ref=new Firebase("http://sweltering-fire-8163.firebaseIO.com/images"),c.images=s(c.ref),c._album=i,c._api_url="https://api.imgur.com/3",c.dropState=d,c.service=a,c.$scope=t,c.$state=r,c.$filter=o,c.$timeout=l,c.$q=e,c.childVisible=!1,c.showTools=!1,c.importVisible=!1,c.importString="",c.defaultImportType={type:"Write something",value:null},c.importType={name:"Write something",value:null},c.inputFocused=!1,document.addEventListener("keydown",function(e){c.importVisible=!0,c.$timeout(function(){});var t=String.fromCharCode(e.keyCode);c.inputFocused||""===t||(c.importString+=t.toLowerCase()),c.$timeout(function(){c.inputFocused=!0,document.getElementById("import-input").focus()},400)}),document.addEventListener("keyup",function(e){13===e.keyCode&&c.importString&&c.importDone();var t=c.recognizeString(c.importString);c.importType=t.type?t:angular.extend({},c.defaultImportType),c.$timeout(function(){})}),c.$scope.$on("$stateChangeStart",function(e,t){c.childVisible="root.image"===t.name})}angular.module("gifseina").controller("MainController",e),e.$inject=["$q","$scope","$http","ALBUM","Imagestore","$state","$filter","$firebaseArray","$timeout","dropState"],e.prototype.recognizeString=function(e){var t,a,i=_.first(e.match(/https?:\/\/.*?\.(?:png|jpg|gif|jpeg|gifv|webm)/i));return i?(t="image/url",a=i):/^[ a-zA-Z0-9\,\.\;\:]{3,}$/.test(e)&&(t="tag",a=_.map(e.split(/[\,\.\;\:]/),function(e){return e.trim()})),{type:t,value:a}},e.prototype.importDone=function(){var e=this;e.importVisible=!1;var t=e.recognizeString(e.importString.trim());e.importString="","image/url"===t.type&&e.importImageFromUrl(t.value),e.importType=angular.extend({},e.defaultImportType),e.inputFocused=!1},e.prototype.importImageFromImgur=function(e){var t=this;t.service.get(t._api_url+"/image/"+e).then(function(e){t.addImage(e.data.data)})},e.prototype.importImageFromUrl=function(e){var t=this,a=t.$filter("imageId")(e);return a?t.importImageFromImgur(a):t.service.post(t._api_url+"/image",{image:e,type:"URL",album:t._album.hash}).then(function(e){200===e.data.status&&t.addImage(e.data.data)})},e.prototype.importFile=function(e){var t=this;"idlist"===e.type?_.map(e.data,t.importImageFromUrl,t):e.data&&e.type&&t.upload(e)},e.prototype.imageDragStart=function(e){var t=this;t.showTools=!0,t.dropState.disabled=!0,t.dragImage=e,t.$timeout(function(){})},e.prototype.imageDragEnd=function(e){var t=this;t.dropState.disabled=!1,t.showTools=!1,t.dragImage=null,t.$timeout(function(){})},e.prototype.getAlbum=function(){var e=this;return e.service.get(e._api_url+"/album/"+e._album.id).then(function(t){return t.data.data.images.forEach(function(t){e.addImage(t)}),t.data})},e.prototype.removeImage=function(e){var t=this;e.deletehash?t.deleteImgurImage(e).then(function(){t.images.$remove(e)}):t.images.$remove(e)},e.prototype.deleteFromImgur=function(e){var t=this;return _.isArray(e)||(e=[e]),t.service["delete"](t._api_url+"album/"+t._album.hash+"/remove_images",{params:{ids:e}})},e.prototype.deleteImgurImage=function(e){var t=this;return t.service["delete"](t._api_url+"/image/"+e.deletehash).then(function(e){return e.data.data})},e.prototype.addImage=function(e){var t=this;e&&(_.isArray(e)?_.forEach(e,function(e){t.addImage(e)}):(e.added=Date.now(),t.images.$add(e)))},e.prototype.upload=function(e){var t=this;return t.service.post(t._api_url+"/image",{album:t._album.hash,image:e.data,type:e.type}).then(function(e){200===e.data.status&&t.addImage(e.data.data)})}}(),function(){"use strict";function e(e,t,a,i){var n=this;n.store=a,n.model=t,n.$scope=e,n.$timeout=i,n.updateTimer=null,n.updateInterval=1e3,n.disabled=!1,n.displayedLinks=["link","mp4","gifv","webm"],n.tagString=n.model.title,n.tags=n.store.getTags(n.tagString);var r=n.updateTags.bind(n);n.$scope.$watch(function(){return n.tagString},r)}e.$inject=["$scope","image","Imagestore","$timeout"],e.prototype.updateTags=function(e,t){var a=this;a.tags=a.store.getTags(a.tagString)},e.prototype.saveTags=function(){var e=this;e.disabled=!0,(_.difference(e.tags,e.model.tags).length>0||_.difference(e.model.tags,e.tags).length>0)&&(e.model.title=e.tagString,e.model.tags=e.store.getTags(e.tagString),e.store.updateImageTags(e.model).then(function(t){e.disabled=!1}))},angular.module("gifseina").controller("ImageController",e)}(),function(){"use strict";angular.module("scroll",[]).directive("scrollY",["$timeout",function(e){return{restrict:"A",scope:{scrollY:"="},link:function(t,a){function i(e){return e.touches.length>0?{x:e.touches[0].pageX,y:e.touches[0].pageY}:{x:e.pageX,y:e.pageY}}function n(e,t,a,i){return e/=i/2,1>e?a/2*e*e+t:(e--,-a/2*(e*(e-2)-1)+t)}function r(e){l=s.offsetHeight,l<s.scrollHeight&&0===s.scrollTop?s.scrollTop=1:l<s.scrollHeight&&s.scrollTop===s.scrollHeight-l&&(s.scrollTop=s.scrollHeight-l-1),e.stopPropagation(),u=!1,d.x=0,d.y=0,c=i(e)}function o(e){if(e.touches.length>1)return void e.preventDefault();var t=i(e);d.x+=t.x-c.x,d.y+=t.y-c.y;var a=s.scrollTop>=s.scrollHeight-l-1&&d.y<0,n=s.scrollTop<2&&d.y>0;u===!1&&(Math.abs(d.y)>Math.abs(d.x)?u="y":Math.abs(d.y)<=Math.abs(d.x)&&(u="x")),"y"!==u||n||a||e.stopPropagation()}var s=a[0],l=0,d={x:0,y:0},c=!1,u=!1;e(function(){t.scrollY&&t.scrollY.y>0&&(s.scrollTop=t.scrollY.y)}),s.addEventListener("touchstart",r),s.addEventListener("touchmove",o),t.scrollY&&s.addEventListener("scroll",function(){t.scrollY.y=s.scrollTop}),t.$on("scroll.to",function(e,t){s.scrollTop=t}),t.$on("scroll.toAnimated",function(e,t){var a=Date.now(),i=500,r=t.offsetTop-s.scrollTop,o=function(){var e=Date.now()-a,l=n(e,r,-r,i);s.scrollTop=t.offsetTop-l,i>e?requestAnimationFrame(o):s.scrollTop=t.offsetTop};requestAnimationFrame(o)}),t.$on("$destroy",function(){s.removeEventListener("touchstart",r),s.removeEventListener("touchmove",o)})}}}])}(),function(){"use strict";angular.module("ripple",[]).directive("ripple",function(){return{restrict:"C",link:function(e,t){function a(e){i.insertBefore(n,i.firstChild),i.classList.remove("ripple-active"),i.classList.add("ripple-active"),n.style.top=e.layerY+"px",n.style.left=e.layerX+"px",r&&clearTimeout(r),r=setTimeout(function(){i.classList.remove("ripple-active"),i.removeChild(n)},1e3)}var i=t[0],n=document.createElement("div"),r=null;n.classList.add("ripple-effect"),i.addEventListener("click",a),i.addEventListener("contextmenu",a)}}})}(),function(){"use strict";angular.module("gifseina").directive("ngRightClick",["$parse",function(e){return function(t,a,i){var n=e(i.ngRightClick);a.bind("contextmenu",function(e){t.$apply(function(){e.preventDefault(),n(t,{$event:e})})})}}])}(),function(){"use strict";angular.module("imageLoader",[]).constant("IMAGE_SIZES",[{name:"s",size:90},{name:"b",size:160},{name:"m",size:320,proportions:!0},{name:"l",size:640,proportions:!0},{name:"h",size:1024,proportions:!0}]).filter("imageId",function(){return function(e){var t=e.match(/^https?:\/\/[^\/]*imgur.com\/(.*\/)?(\w+)(\.\w+)?$/i);return t?t[2]:null}}).filter("thumbnail",function(){return function(e,t){return e.replace(/(\w+)(\.\w+)$/i,"$1"+t+"$2")}}).directive("imageLoader",["$filter",function(e){return{restrict:"A",scope:{imageLoader:"=",size:"@?"},link:function(t,a,i){function n(){o.classList.remove("image-loading"),o.classList.add("image-ready"),"IMG"===o.nodeName?o.src=s.src:o.style["background-image"]="url("+s.src+")",s=null}function r(){var a=t.imageLoader;a.nsfw&&o.classList.add("image-nsfw"),o.classList.add("image-loading"),o.classList.remove("image-ready"),s=new Image,s.onload=function(){n()},s.onerror=function(){o.classList.add("image-error"),n()};var i=a.link;/\.(gif|jpg|jpeg|png|gifv|mp4)$/i.test(i)?(t.size&&(i=e("thumbnail")(i,t.size)),s.src=i):s.src=null}var o=a[0],s=null;r()}}}])}(),function(){"use strict";function e(e,t){var a=this;a.$q=t,a.service=e,a.images=[],a.tags=[]}e.$inject=["$http","$q"],e.prototype.getAllTags=function(){var e=this;e.tags=_.chain(e.images).map(function(e){return e.tags}).flatten().compact().groupBy().sortBy(function(e){return-e.length}).map(function(e){return _.first(e)}).slice(0,10).valueOf(),console.log(e.tags)},e.prototype.updateImageTags=function(e){var t=this;if(e.can_update&&e.deletehash)return t.service.post("https://api.imgur.com/3/image/"+e.deletehash,{title:t.getTagString(e)}).then(function(e){return e.data});var a=t.$q.defer();return a.reject(null),a.promise},e.prototype.getDeleteHash=function(e){if(e.description){var t=new RegExp(/#[a-zA-Z0-9]+#/),a=_.first(e.description.match(t));return a?a.replace(/\#/g,""):null}return null},e.prototype.getTagString=function(e){return e.tags?e.tags.join(","):null},e.prototype.getTags=function(e){var t=e?e.replace(/[^,\.\:\;\ a-zA-ZöäÖÄåÅ0-9]/g,"").split(/[\,\;\.\: ]{1}/):[];return _.compact(_.map(_.uniq(t),function(e){return _.trim(e)}))},e.prototype.parseImages=function(){var e=this;e.images.reverse(),e.images.forEach(function(t){var a=e.getDeleteHash(t);a?(t.tags=e.getTags(t.title),t.deletehash=a,t.can_update=!0):t.can_update=!1}),e.getAllTags()},e.prototype.set=function(e){var t=this;angular.extend(t,e),t.parseImages()},angular.module("gifseina").service("Imagestore",e)}(),function(){"use strict";function e(e,t,a,i){var n=this;n.$scope=a,n.$q=e,n.$filter=i,n.$http=t,n.allowedTypes=["image/gif","image/jpg","image/png","image/jpeg"],n.maxFileSize=10383360}e.$inject=["$q","$http","$scope","$filter"],e.prototype.isAllowed=function(e){var t=this;return t.allowedTypes.indexOf(e.type)>-1&&e.size<t.maxFileSize},e.prototype.readFile=function(e){var t=this,a=t.$q.defer(),i=new FileReader;return i.onloadend=function(){a.resolve(i.result)},i.readAsDataURL(e),a.promise},e.prototype.findImage=function(e){var t=new RegExp(/(https?:\/\/.*?\.(?:png|jpg|gif|jpeg))/i),a=e.match(t);return a?_.first(a):null},e.prototype.handleDrop=function(e){var t=this,a=[];_.forEach(e.dataTransfer.items,function(e){var i=t.$q.defer();a.push(i.promise),e.getAsString(function(e){var a=t.findImage(e);i.resolve(a)})}),t.$q.all(a).then(function(e){var a=_.compact(_.uniq(e));t.$scope.onFileRead({data:{type:"idlist",data:a}})}),_.forEach(e.dataTransfer.files,function(e){t.isAllowed(e)&&t.readFile(e).then(function(e){var e=e.split("base64,"),a=e[0].replace("data:","").replace(";","");t.$scope.onFileRead({data:{type:a,data:e[1]}})})})},angular.module("dropinput",[]).service("dropState",function(){var e=this;e.disabled=!1}).directive("dropInput",["dropState",function(t){return{restrict:"A",scope:{onFileRead:"&"},bindToController:{},controller:e,controllerAs:"drop",link:function(e,a,i,n){var r=a[0];r.addEventListener("dragenter",function(e){e.preventDefault(),t.disabled||(e.dataTransfer.dropEffect="copy")}),r.addEventListener("dragover",function(e){e.preventDefault(),r.classList.contains("on-drop")||t.disabled||r.classList.add("on-drop")}),r.addEventListener("dragleave",function(e){r.classList.remove("on-drop")}),r.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),r.classList.remove("on-drop"),t.disabled||n.handleDrop(e)})}}}])}(),function(){"use strict";angular.module("gifseina").directive("droppable",function(){return{scope:{onDrop:"&"},restrict:"A",link:function(e,t,a){var i=t[0];i.addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect="move",i.classList.contains("on-drag")||i.classList.add("on-drag")}),i.addEventListener("dragleave",function(e){i.classList.remove("on-drag")}),i.addEventListener("drop",function(t){t.stopPropagation(),t.preventDefault(),i.classList.remove("on-drag"),e.onDrop&&e.onDrop()})}}}).directive("draggable",function(){return{scope:{dragStart:"&",dragEnd:"&"},restrict:"A",link:function(e,t,a){var i=t[0];i.addEventListener("dragend",function(t){t.preventDefault(),t.stopPropagation(),e.dragEnd&&e.dragEnd()}),i.addEventListener("dragstart",function(t){t.dataTransfer.dragEffect="move",t.dataTransfer.setData("type",i.getAttribute("data-type")),t.dataTransfer.setData("$id",i.getAttribute("data-drag")),e.dragStart&&e.dragStart()})}}})}(),function(){"use strict";angular.module("clipboard",[]).directive("copyClipboard",function(){return{restrict:"AC",link:function(e,t){function a(e){e.preventDefault();var t=document.createElement("textarea");document.body.appendChild(t);try{t.value=i.getAttribute("data-text"),t.focus(),t.select(),document.execCommand("Copy")}catch(a){alert(i.innerHTML)}t.remove()}var i=t[0];i.addEventListener("click",a),i.addEventListener("touchstart",a)}}})}(),function(){"use strict";function e(e,t,a){t.$on("$stateChangeError",function(){a.go("root")}),e.debug("runBlock end")}angular.module("gifseina").run(e),e.$inject=["$log","$rootScope","$state"]}(),function(){"use strict";function e(e,t){e.state("root",{url:"/",templateUrl:"app/main/main.html",controller:"MainController",controllerAs:"main"}).state("root.image",{resolve:{image:["Imagestore","$stateParams","$q",function(e,t,a){var i=a.defer(),n=_.find(e.images,{id:t.id});return n?i.resolve(n):i.reject(),i.promise}]},url:":id",templateUrl:"app/image/image.html",controller:"ImageController",controllerAs:"image"}),t.otherwise("/")}angular.module("gifseina").config(e),e.$inject=["$stateProvider","$urlRouterProvider"]}(),function(){"use strict";angular.module("gifseina").constant("ALBUM",{id:"zxdFD",hash:"QqctTpQTUXLOzyr"}).constant("APIKEY","85d6831fa9b79de").constant("APISECRET","0d31d1a48d0a014304a0dcdb0df603d64bee4515")}(),function(){"use strict";function e(e,t,a,i,n){n.includeSpinner=!1,i.defaults.headers.common.Authorization="Client-ID "+t,e.debugEnabled(!0)}angular.module("gifseina").config(e),e.$inject=["$logProvider","APIKEY","APISECRET","$httpProvider","cfpLoadingBarProvider"]}(),angular.module("gifseina").run(["$templateCache",function(e){e.put("app/image/image.html",'<div class="view-overlay" ui-sref="root"></div><div class="view" scroll-y=""><div class="image-preview-wrapper col-xs-12 no-gutter"><div class="image-preview" image-loader="image.model"></div></div><div class="image-info-wrapper col-xs-12"><div class="input-wrapper col-xs-12 col-md-12" ng-if="image.model.can_update"><div class="input-container"><input ng-blur="image.saveTags()" ng-disabled="{{image.disabled}}" type="text" name="name" ng-model="image.tagString" ng-class="{\'has-value\' : image.model.title}"> <label>Tags</label></div><div class="tags-list"><div class="tag" ng-repeat="(tagIndex, tag) in image.tags track by tagIndex"><span ng-bind="tag"></span></div></div></div><div class="col-xs-12"><h3>image links</h3><table class="image-info"><tr class="info-label" ng-if="::image.model[link]" ng-repeat="(linkIndex, link) in ::image.displayedLinks track by linkIndex"><td class="property">{{::link}}</td><td class="value">{{::image.model[link]}}</td></tr></table></div><div class="col-xs-12"><h3>image info</h3><table class="image-info"><tr class="info-label" ng-repeat="(key, value) in image.model track by key" ng-if="key && value"><td class="property">{{::key}}</td><td class="value">{{::value}}</td></tr></table></div></div></div>'),e.put("app/main/main.html",'<div class="view" layout="column" drop-input="" on-file-read="main.importFile(data)" ng-class="{\'child-visible\' : main.childVisible}"><header class="col-xs-12 text-center"><h1><strong><span class="hilight">gi</span>hvin</strong></h1><h3>postaajan kuva kirja</h3><p>Upload with drag & drop</p></header><section name="image-list" class="view" scroll-y=""><div class="row"><div class="view-header-offset col-xs-12 text-center"><h1><strong>gihvin</strong></h1><h3>postaajan apu kirja</h3><p>Upload with drag & drop</p></div><div class="gradient-top col-xs-12"></div><div class="image-wrapper col-xs-12" layout="row"><div class="image-container" id="{{::image.$id}}" draggable="true" drag-start="main.imageDragStart(image)" drag-end="main.imageDragEnd(image)" ng-repeat="(imageIndex, image) in main.images | orderBy:\'-added\' track by image.$id" ng-style="{\'flex-basis\' : (image.width / image.height) * 160 +\'px\'}"><div image-loader="::image" size="m"></div><div class="image-overlay ripple" copy-clipboard="" data-text="[img]{{::image.link}}[/img]"></div></div></div></div></section></div><div class="import-input" ng-class="{\'visible\' : main.importVisible}"><div class="input-container"><input id="import-input" ng-blur="main.importDone()" type="text" name="name" ng-model="main.importString" ng-class="{\'has-value\' : image.importString}"> <label ng-bind="main.importType.type"></label></div></div><div class="toolbar" ng-class="{\'visible\' : main.showTools}"><div class="tool" droppable="true" on-drop="main.removeImage(main.dragImage)"><i class="ion-ios-trash-outline"></i></div></div><ui-view class="view-animate view-child"></ui-view>')}]);